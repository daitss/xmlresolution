<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: XmlResolution::SchemaCatalog
  
    &mdash; XML Resolution Service
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../XmlResolution.html" title="XmlResolution (module)">XmlResolution</a></span></span>
     &raquo; 
    <span class="title">SchemaCatalog</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: XmlResolution::SchemaCatalog
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">XmlResolution::SchemaCatalog</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Build up a catalog of schemas from a hash of { Location-URLs =&gt;
Namespace-URIs }, downloading the schemas. Only HTTP-schemed Location-URLs
are supported.  SchemaCatalog does not, by itself,  analyze schemas for
additional schemas to download - see our Nokogiri::XML::SAX::Document
subclasses PlainXmlDocument and SchemaDocument for that functionality.</p>

<p>SchemaCatalog builds a dictionary of interesting information about schemas.
These are accessed with the SchemaCatalog#schemas iterator.  Each record
yielded has the following methods:</p>
<table class="rdoc-list"><tr><td class="rdoc-term"><p>location</p></td>
<td>
<p>the location of the schema, an HTTP-schemed URL.</p>
</td></tr><tr><td class="rdoc-term"><p>namespace</p></td>
<td>
<p>the namespace associated with this schema.</p>
</td></tr><tr><td class="rdoc-term"><p>last_modified</p></td>
<td>
<p>on a successful retrieval, this is the last-modified time of the schema (a
Time object). If last-modified wasn’t available, this is the current
datetime.</p>
</td></tr><tr><td class="rdoc-term"><p>digest</p></td>
<td>
<p>on a successful retrieval, the MD5 digest of the retrieved text of the
schema.</p>
</td></tr><tr><td class="rdoc-term"><p>localpath</p></td>
<td>
<p>on a successful retrieval, the filename of the locally-stored copy of the
schema.</p>
</td></tr><tr><td class="rdoc-term"><p>retrieval_status</p></td>
<td>
<p>the outcome of retrieving the schema: one of :success, :failure, or
:redirect.</p>
</td></tr><tr><td class="rdoc-term"><p>error_message</p></td>
<td>
<p>if retrieval_status is :failure, this will be the associated error message.
Usually a Net::HTTP exception, it could also represent a run-time
exception.</p>
</td></tr><tr><td class="rdoc-term"><p>redirected_location</p></td>
<td>
<p>if retrieval_status is :redirect, this will be the initial Location URL;
the location slot contains the address of the retrieved schema text.</p>
</td></tr></table>


  </div>
</div>
<div class="tags">
  
</div>




  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#fetch-instance_method" title="#fetch (instance method)">- (Object) <strong>fetch</strong>(location, limit = 5) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>fetch LOCATION [ REDIRECT-LIMIT ].</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#file_recorded%3F-instance_method" title="#file_recorded? (instance method)">- (Boolean) <strong>file_recorded?</strong>(filename, mtime, digest) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>file_recorded? FILENAME, MTIME, DIGEST.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#get_schema_record-instance_method" title="#get_schema_record (instance method)">- (Object) <strong>get_schema_record</strong>(location, namespace) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>get_schema_record LOCATION, NAMESPACE.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (SchemaCatalog) <strong>initialize</strong>(namespace_locations, data_storage_path = '/tmp/', proxy = nil) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>SchemaCatalog.new(NAMESPACE_LOCATIONS, DATA_STORAGE_PATH, [ PROXY ]).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#merge-instance_method" title="#merge (instance method)">- (Object) <strong>merge</strong>(namespace_locations) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>merge NAMESPACE_LOCATIONS.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#schemas-instance_method" title="#schemas (instance method)">- (Object) <strong>schemas</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>schemas.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="XmlResolution::SchemaCatalog (class)">SchemaCatalog</a></span></tt>) <strong>initialize</strong>(namespace_locations, data_storage_path = '/tmp/', proxy = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>SchemaCatalog.new(NAMESPACE_LOCATIONS, DATA_STORAGE_PATH, [ PROXY ])</p>

<p>Creates a catalog of schemas.  DATA_STORAGE_PATH provides a path to where
downloaded schemas can be saved. PROXY, if supplied, is the address and
port of a caching web proxy, e.g. squid.example.com:3128.</p>

<p>NAMESPACE_LOCATIONS is a hash of Location-URL/Namespace-URN key/value pairs
of schemas that will downloaded; the SchemaCatalog provides a convenient
data structure to recursively analyze a set of schemas:</p>

<pre class="code"><span class='catalog identifier id'>catalog</span> <span class='assign token'>=</span> <span class='SchemaCatalog constant id'>SchemaCatalog</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='namespace_locations identifier id'>namespace_locations</span><span class='comma token'>,</span> <span class='string val'>'/tmp/'</span><span class='rparen token'>)</span>

<span class='catalog identifier id'>catalog</span><span class='dot token'>.</span><span class='schemas identifier id'>schemas</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='schema_record identifier id'>schema_record</span><span class='bitor op'>|</span>
  <span class='more_namespace_locations identifier id'>more_namespace_locations</span> <span class='assign token'>=</span>  <span class='analyze_schema identifier id'>analyze_schema</span><span class='lparen token'>(</span><span class='schema_record identifier id'>schema_record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span><span class='rparen token'>)</span>
  <span class='catalog identifier id'>catalog</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='more_namespace_locations identifier id'>more_namespace_locations</span><span class='rparen token'>)</span>
 <span class='end end kw'>end</span>
</pre>

<p>(What’s happening above is that the iterator catalog.schemas is being
augmented via the catalog.merge method, allowing us to recursively search
the schemas.)</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 82</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='namespace_locations identifier id'>namespace_locations</span><span class='comma token'>,</span> <span class='data_storage_path identifier id'>data_storage_path</span> <span class='assign token'>=</span> <span class='string val'>'/tmp/'</span><span class='comma token'>,</span> <span class='proxy identifier id'>proxy</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='if if kw'>if</span> <span class='proxy identifier id'>proxy</span>
    <span class='@proxy_addr ivar id'>@proxy_addr</span><span class='comma token'>,</span> <span class='@proxy_port ivar id'>@proxy_port</span> <span class='assign token'>=</span> <span class='proxy identifier id'>proxy</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>':'</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
    <span class='@proxy_port ivar id'>@proxy_port</span>  <span class='assign token'>=</span> <span class='@proxy_port ivar id'>@proxy_port</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='integer val'>3128</span> <span class='colon op'>:</span> <span class='@proxy_port ivar id'>@proxy_port</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
  <span class='end end kw'>end</span>

  <span class='@processed_locations ivar id'>@processed_locations</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@data_root ivar id'>@data_root</span> <span class='assign token'>=</span> <span class='data_storage_path identifier id'>data_storage_path</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span>

  <span class='ResolverUtils constant id'>ResolverUtils</span><span class='dot token'>.</span><span class='check_directory identifier id'>check_directory</span> <span class='string val'>&quot;The schema storage directory&quot;</span><span class='comma token'>,</span> <span class='@data_root ivar id'>@data_root</span>

  <span class='@schema_dictionary ivar id'>@schema_dictionary</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='merge identifier id'>merge</span> <span class='namespace_locations identifier id'>namespace_locations</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="fetch-instance_method">
  
    - (<tt>Object</tt>) <strong>fetch</strong>(location, limit = 5)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>fetch LOCATION [ REDIRECT-LIMIT ]</p>

<p>Given an HTTP location LOCATION, fetch and return the response. Permit up
to five redirections by default.</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="LocationError.html" title="XmlResolution::LocationError (class)">LocationError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 203</span>

<span class='def def kw'>def</span> <span class='fetch identifier id'>fetch</span> <span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='integer val'>5</span>

  <span class='uri identifier id'>uri</span> <span class='assign token'>=</span> <span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span> <span class='location identifier id'>location</span>

  <span class='raise identifier id'>raise</span> <span class='LocationError constant id'>LocationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{uri.scheme} is not a supported protocol - #{location} not retrieved.&quot;</span>  <span class='unless unless_mod kw'>unless</span> <span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='scheme identifier id'>scheme</span> <span class='eq op'>==</span> <span class='string val'>'http'</span>
  <span class='raise identifier id'>raise</span> <span class='LocationError constant id'>LocationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{location} can't be retrieved, there were too many redirects.&quot;</span>          <span class='if if_mod kw'>if</span> <span class='limit identifier id'>limit</span> <span class='lt op'>&lt;</span> <span class='integer val'>1</span>

  <span class='comment val'># Note that if proxy_addr &amp; proxy_port are nil,  Net::HTTP::Proxy is equivalent to Net::HTTP</span>

  <span class='comment val'># TODO: set aggressive timeout</span>

  <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTP constant id'>HTTP</span><span class='colon2 op'>::</span><span class='Proxy constant id'>Proxy</span><span class='lparen token'>(</span><span class='@proxy_addr ivar id'>@proxy_addr</span><span class='comma token'>,</span> <span class='@proxy_port ivar id'>@proxy_port</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='start identifier id'>start</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='host identifier id'>host</span><span class='comma token'>,</span> <span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='port identifier id'>port</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='http identifier id'>http</span><span class='bitor op'>|</span>
    <span class='response identifier id'>response</span>  <span class='assign token'>=</span> <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
    <span class='case case kw'>case</span> <span class='response identifier id'>response</span>
    <span class='when when kw'>when</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTPSuccess constant id'>HTTPSuccess</span>     <span class='then then kw'>then</span> <span class='return return kw'>return</span> <span class='lbrack token'>[</span> <span class='response identifier id'>response</span><span class='comma token'>,</span> <span class='location identifier id'>location</span> <span class='rbrack token'>]</span>
    <span class='when when kw'>when</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTPRedirection constant id'>HTTPRedirection</span> <span class='then then kw'>then</span> <span class='fetch identifier id'>fetch</span> <span class='response identifier id'>response</span><span class='lbrack token'>[</span><span class='string val'>'location'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='minus op'>-</span> <span class='integer val'>1</span>
    <span class='else else kw'>else</span>
      <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='error! fid id'>error!</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="file_recorded?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>file_recorded?</strong>(filename, mtime, digest)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>file_recorded? FILENAME, MTIME, DIGEST</p>

<p>A boolean method, return whether FILENAME has the mtime MTIME and MD5
Digest DIGEST. FILENAME does not have to exist, but if it does, it must be
readable.</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


231
232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 231</span>

<span class='def def kw'>def</span> <span class='file_recorded? fid id'>file_recorded?</span> <span class='filename identifier id'>filename</span><span class='comma token'>,</span> <span class='mtime identifier id'>mtime</span><span class='comma token'>,</span> <span class='digest identifier id'>digest</span>
  <span class='return return kw'>return</span> <span class='false false kw'>false</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span>
  <span class='ResolverUtils constant id'>ResolverUtils</span><span class='dot token'>.</span><span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='fd identifier id'>fd</span><span class='bitor op'>|</span> <span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='mtime identifier id'>mtime</span><span class='lparen token'>(</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='mtime identifier id'>mtime</span><span class='rparen token'>)</span> <span class='and and kw'>and</span> <span class='lparen token'>(</span><span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span><span class='lparen token'>(</span><span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='digest identifier id'>digest</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_schema_record-instance_method">
  
    - (<tt>Object</tt>) <strong>get_schema_record</strong>(location, namespace)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>get_schema_record LOCATION, NAMESPACE</p>

<p>Retrieve the schema from LOCATION, if possible.  Save the text of the
schema to a directory.  Returns a record listing the location, namespace,
text location, digest and last-modification time; See the detailed
description of the @schema_dictionary instance variable for the details.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 169</span>

<span class='def def kw'>def</span> <span class='get_schema_record identifier id'>get_schema_record</span> <span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='namespace identifier id'>namespace</span>

  <span class='record identifier id'>record</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='colon2 op'>::</span><span class='Schema constant id'>Schema</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='namespace identifier id'>namespace</span><span class='rparen token'>)</span>

  <span class='response identifier id'>response</span><span class='comma token'>,</span> <span class='actual_location identifier id'>actual_location</span> <span class='assign token'>=</span> <span class='fetch identifier id'>fetch</span> <span class='location identifier id'>location</span>

  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='digest identifier id'>digest</span>           <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span><span class='lparen token'>(</span><span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='rparen token'>)</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='last_modified identifier id'>last_modified</span>    <span class='assign token'>=</span> <span class='response identifier id'>response</span><span class='lbrack token'>[</span><span class='string val'>'Last-Modified'</span><span class='rbrack token'>]</span> <span class='question op'>?</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='response identifier id'>response</span><span class='lbrack token'>[</span><span class='string val'>'Last-Modified'</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span>        <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='@data_root ivar id'>@data_root</span><span class='comma token'>,</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='digest identifier id'>digest</span><span class='rparen token'>)</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='location identifier id'>location</span>         <span class='assign token'>=</span> <span class='actual_location identifier id'>actual_location</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='retrieval_status identifier id'>retrieval_status</span> <span class='assign token'>=</span> <span class='symbol val'>:success</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='file_recorded? fid id'>file_recorded?</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span><span class='comma token'>,</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='last_modified identifier id'>last_modified</span><span class='comma token'>,</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='digest identifier id'>digest</span><span class='rparen token'>)</span>
    <span class='ResolverUtils constant id'>ResolverUtils</span><span class='dot token'>.</span><span class='write_lock identifier id'>write_lock</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='fd identifier id'>fd</span><span class='bitor op'>|</span>
      <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='write identifier id'>write</span> <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span>
      <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='utime identifier id'>utime</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='atime identifier id'>atime</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='last_modified identifier id'>last_modified</span><span class='comma token'>,</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='localpath identifier id'>localpath</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='record identifier id'>record</span>

<span class='rescue rescue kw'>rescue</span> <span class='Exception constant id'>Exception</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='retrieval_status identifier id'>retrieval_status</span> <span class='assign token'>=</span> <span class='symbol val'>:failure</span>
  <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='error_message identifier id'>error_message</span>    <span class='assign token'>=</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='message identifier id'>message</span>   <span class='comment val'># It is the calling program's responsibility to log this error</span>
  <span class='return return kw'>return</span> <span class='record identifier id'>record</span>                         <span class='comment val'># when appropriate; use the schemas method for iterating over</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="merge-instance_method">
  
    - (<tt>Object</tt>) <strong>merge</strong>(namespace_locations) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>merge NAMESPACE_LOCATIONS</p>

<p>NAMESPACE_LOCATIONS is a hash of location-URL/namespace-URN key/value
pairs, the same data structure passed to us in the constructor.</p>

<p>Merge lets us add new schema records to the SchemaCatalog, but we take care
not to overwrite existing records that have already been processed.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 131</span>

<span class='def def kw'>def</span> <span class='merge identifier id'>merge</span> <span class='namespace_locations identifier id'>namespace_locations</span>

  <span class='comment val'># For each location in NAMESPACE_LOCATIONS hash, check to see if</span>
  <span class='comment val'># they aren't yet in our schema_dictionary, go fetch them.  If we</span>
  <span class='comment val'># get a schema record that has a different location than we asked</span>
  <span class='comment val'># for, one or more redirects occured: mark it as such.</span>

  <span class='namespace_locations identifier id'>namespace_locations</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='namespace identifier id'>namespace</span><span class='bitor op'>|</span>

    <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='@processed_locations ivar id'>@processed_locations</span><span class='lbrack token'>[</span><span class='location identifier id'>location</span><span class='rbrack token'>]</span>

    <span class='schema_record identifier id'>schema_record</span> <span class='assign token'>=</span> <span class='get_schema_record identifier id'>get_schema_record</span><span class='lparen token'>(</span><span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='namespace identifier id'>namespace</span><span class='rparen token'>)</span>

    <span class='@schema_dictionary ivar id'>@schema_dictionary</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='schema_record identifier id'>schema_record</span>
    <span class='@processed_locations ivar id'>@processed_locations</span><span class='lbrack token'>[</span><span class='schema_record identifier id'>schema_record</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

    <span class='if if kw'>if</span> <span class='schema_record identifier id'>schema_record</span><span class='dot token'>.</span><span class='location identifier id'>location</span> <span class='neq op'>!=</span> <span class='location identifier id'>location</span>   <span class='comment val'># then one or more redirects</span>

      <span class='original identifier id'>original</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='colon2 op'>::</span><span class='Schema constant id'>Schema</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='schema_record identifier id'>schema_record</span><span class='dot token'>.</span><span class='namespace identifier id'>namespace</span><span class='rparen token'>)</span>
      <span class='original identifier id'>original</span><span class='dot token'>.</span><span class='retrieval_status identifier id'>retrieval_status</span>    <span class='assign token'>=</span> <span class='symbol val'>:redirect</span>
      <span class='original identifier id'>original</span><span class='dot token'>.</span><span class='redirected_location identifier id'>redirected_location</span> <span class='assign token'>=</span> <span class='schema_record identifier id'>schema_record</span><span class='dot token'>.</span><span class='location identifier id'>location</span>

      <span class='@schema_dictionary ivar id'>@schema_dictionary</span><span class='dot token'>.</span><span class='push identifier id'>push</span>  <span class='original identifier id'>original</span>
      <span class='@processed_locations ivar id'>@processed_locations</span><span class='lbrack token'>[</span><span class='original identifier id'>original</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="schemas-instance_method">
  
    - (<tt>Object</tt>) <strong>schemas</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>schemas</p>

<p>Our main iterator - yields the next schema record when given a block,
otherwise a complete list of the schema records, alphabetically sorted by
location.</p>

<p>It is expected that the catalog will be expanded through the merge method
while being iterated over, as in the following example:</p>

<pre class="code"><span class='catalog identifier id'>catalog</span> <span class='assign token'>=</span> <span class='SchemaCatalog constant id'>SchemaCatalog</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='namespace_locations identifier id'>namespace_locations</span><span class='comma token'>,</span> <span class='string val'>'tmp'</span><span class='rparen token'>)</span>
<span class='catalog identifier id'>catalog</span><span class='dot token'>.</span><span class='schemas identifier id'>schemas</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span>
  <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='retrieval_status identifier id'>retrieval_status</span> <span class='neq op'>!=</span> <span class='symbol val'>:success</span>
  <span class='additional_namespace_locations identifier id'>additional_namespace_locations</span> <span class='assign token'>=</span> <span class='my_application identifier id'>my_application</span><span class='lparen token'>(</span><span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='comma token'>,</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='pathname identifier id'>pathname</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='catalog identifier id'>catalog</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span> <span class='additional_namespace_locations identifier id'>additional_namespace_locations</span>
<span class='end end kw'>end</span>
</pre>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


113
114
115
116
117
118
119</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/xmlresolution/lib/xmlresolution/schema_catalog.rb', line 113</span>

<span class='def def kw'>def</span> <span class='schemas identifier id'>schemas</span>
  <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
    <span class='@schema_dictionary ivar id'>@schema_dictionary</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='record identifier id'>record</span><span class='bitor op'>|</span> <span class='yield yield kw'>yield</span> <span class='record identifier id'>record</span> <span class='rbrace token'>}</span>   <span class='comment val'># need to preserve order here: the array acts as a queue in this role.</span>
  <span class='else else kw'>else</span>
    <span class='@schema_dictionary ivar id'>@schema_dictionary</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='comma token'>,</span><span class='b identifier id'>b</span><span class='bitor op'>|</span> <span class='a identifier id'>a</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='dot token'>.</span><span class='downcase identifier id'>downcase</span> <span class='cmp op'>&lt;=&gt;</span> <span class='b identifier id'>b</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='dot token'>.</span><span class='downcase identifier id'>downcase</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Fri Aug 19 15:30:05 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.8.7).
</div>

  </body>
</html>